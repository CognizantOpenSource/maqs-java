name: Pull Request Pipeline

on:
  pull_request:
    branches: main

jobs:
  unit_tests:
    name: Unit Test Execution
    runs-on: ubuntu-latest
    strategy:
      matrix:
        #jdk: [8, 11, 13, 15]
         jdk: [11]
    steps:
      - uses: actions/checkout@v2
      - name: Set up JDK ${{matrix.jdk}}
        uses: actions/setup-java@v1
        with:
          java-version: 15
      - name: Restore Local Maven Cache
        uses: actions/cache@v3.0.2
        with:
          path: ~/.m2
          key: ${{runner.os}}-m2
      - name: Build the docker-compose stack
        run: docker-compose -f docker/MAQSSQLServer/docker-compose.yml -p CognizantOpenSource/maqs-java up -d
      - uses: actions/setup-dotnet@v1
        with:
          dotnet-version: |
            3.1.x
            6.x.x
      - name: Start test service
        run: Start-Process -FilePath "dotnet" -ArgumentList "run --project docker/MAQSService/MainTestService/MainTestService.csproj"
        shell: pwsh
      - name: Create settings file
        uses: InstaCode/maven-settings-xml-action@v9
        with:
          profiles: '[{ "id": "sonar", "properties": { "sonar.organization":"cognizantopensource", "sonar.host.url":"https://sonarcloud.io", "sonar.login": "${{secrets.SONAR_TOKEN}}" }}]'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Cache SonarCloud packages
        uses: actions/cache@v3.0.2
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar
      - name: Cache Maven packages
        uses: actions/cache@v3.0.2
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2
      - name: Build and analyze
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # Needed to get PR information, if any
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: mvn -B  -P integration-test -Dtesting verify package --file pom.xml -e -fae -T 1C -Djdk.version=${{matrix.jdk}}  org.sonarsource.scanner.maven:sonar-maven-plugin:sonar -Dsonar.projectKey=CognizantOpenSource_maqs-java
      - name: Publish Unit Test Results Report
        uses: scacap/action-surefire-report@v1
        if: ${{ always() }}
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          check_name: Unit Test Results
      - name: Upload Test Result Logs
        if: ${{ always() }}
        uses: actions/upload-artifact@v2
        with:
          name: Logs
          path: ./**/logs
  checkstyle:
    name: Checkstyle Run
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Set up JDK 11
        uses: actions/setup-java@v1
        with:
          java-version: 11
      - name: Restore Local Maven Cache
        uses: actions/cache@v3.0.2
        with:
          path: ~/.m2
          key: ${{runner.os}}-m2
      - name: Run Checkstyle
        run: mvn -B validate --file pom.xml -e -fae
  labels:
    name: Pull Request Labels
    if: github.actor != 'dependabot[bot]'
    runs-on: ubuntu-latest
    steps:
      - name: Label Pull Request
        uses: actions/labeler@v3
        with:
          repo-token: "${{ secrets.GITHUB_TOKEN }}"
